<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-05-19 Thu 10:45 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Securing SSH Keys with MFA</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Securing SSH Keys with MFA</h1>

<div id="outline-container-org191eb48" class="outline-2">
<h2 id="org191eb48">About speaker</h2>
<div class="outline-text-2" id="text-org191eb48">
<ul class="org-ul">
<li>Hi! I'm Eduardo Robles I work at the City of Pharr Innovation &amp; Technlogy department as a Support Analyst.</li>
<li>Since I was a kid technology was a passion of mine and I wanted to be an inventor.</li>
<li>You can check out my skills over on my blog or LinkedIn. <b>Bonus, I give out a lot of free advice over there.</b></li>
</ul>
</div>
</div>

<div id="outline-container-orgd260e5a" class="outline-2">
<h2 id="orgd260e5a">Securing SSH Keys with MFA</h2>
<div class="outline-text-2" id="text-orgd260e5a">
<p>
Main Topics:
</p>
<ol class="org-ol">
<li>Learn the basics of SSH key authentication</li>
<li>Demonstrate how to implement MFA on SSH keys</li>
<li>Learn the benefits and downsides to MFA on SSH keys</li>
<li>Some tips/tricks for SSH management</li>
</ol>
</div>
</div>

<div id="outline-container-org33a0c03" class="outline-2">
<h2 id="org33a0c03">Before we begin&#x2026;</h2>
<div class="outline-text-2" id="text-org33a0c03">
<ul class="org-ul">
<li>This talk is for an intermediate users</li>
<li>OpenSSH version 8 or greater (both server and Client)</li>
<li>This presentation is Linux/Unix heavy</li>
<li>OpenSSH is available on latest Windows builds but your mileage may vary (try WSL?)</li>
</ul>
</div>
</div>

<div id="outline-container-org9cab773" class="outline-2">
<h2 id="org9cab773">What inspired this talk?</h2>
<div class="outline-text-2" id="text-org9cab773">
<ul class="org-ul">
<li>A projects, a raspberry pi, and ssh proxies.</li>
</ul>
</div>
</div>

<div id="outline-container-orgde31242" class="outline-2">
<h2 id="orgde31242">How SSH Authentication Works</h2>
<div class="outline-text-2" id="text-orgde31242">
</div>
<div id="outline-container-org425a6bc" class="outline-3">
<h3 id="org425a6bc">Keys, Keys, and more Keys!</h3>
<div class="outline-text-3" id="text-org425a6bc">
<p>
SSH employs <b>Public Key</b> authentication, meaning all cryptographic functions are done asymmetrically.
<a href="https://www.digitalocean.com/community/tutorials/understanding-the-ssh-encryption-and-connection-process">DigitalOcean - Understanding the SSH Encryption and Connection Process</a>
</p>

<blockquote>
<p>
The more well-discussed use of asymmetrical encryption with SSH comes from SSH key-based authentication. SSH key pairs can be used to authenticate a client to a server. The client creates a key pair and then uploads the public key to any remote server it wishes to access. This is placed in a file called authorized<sub>keys</sub> within the ~/.ssh directory in the user account’s home directory on the remote server.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org1ee1e42" class="outline-3">
<h3 id="org1ee1e42">Public and Private Key Cryptography</h3>
<div class="outline-text-3" id="text-org1ee1e42">
<p>
<a href="https://commons.wikimedia.org/wiki/File:Public-key-crypto-1.svg#/media/File:Public-key-crypto-1.svg">Source: Wikipedia - Public-key cryptography</a>
</p>
</div>
</div>
<div id="outline-container-org7be2262" class="outline-3">
<h3 id="org7be2262">SSH And Yubikey</h3>
<div class="outline-text-3" id="text-org7be2262">
<ul class="org-ul">
<li>Magic of FIDO/U2F</li>
</ul>
<p>
<a href="https://www.openssh.com/txt/release-8.2">https://www.openssh.com/txt/release-8.2</a>
</p>
<blockquote>
<p>
U2F/FIDO are open standards for inexpensive two-factor authentication hardware that are widely used for website authentication. In OpenSSH FIDO devices are supported by new public key types "ecdsa-sk" and "ed25519-sk", along with corresponding certificate types.
</p>
</blockquote>
<ul class="org-ul">
<li>How FIDO Works</li>
</ul>
<blockquote>
<p>
During registration with an online service, the user’s client device creates a new key pair. It retains the private key and registers the public key with the online service. Authentication is done by the client device proving possession of the private key to the service by signing a challenge. The client’s private keys can be used only after they are unlocked locally on the device by the user.
</p>
</blockquote>
<p>
<a href="https://fidoalliance.org/wp-content/uploads/2014/12/graphic_Registration.png">Source: https://fidoalliance.org/how-fido-works/</a>
</p>
</div>
</div>
<div id="outline-container-org13639d7" class="outline-3">
<h3 id="org13639d7">SSH and TOTP</h3>
<div class="outline-text-3" id="text-org13639d7">
<ul class="org-ul">
<li>Once upon a time
Time based One Time Passcode or TOTP for short is a method of securing authentication with short random codes. Codes are generated by an app or service like Google Authenticator or Microsoft Authenticator. You may be most familiar with using MFA app for your email or bank sign-on.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd5d3397" class="outline-2">
<h2 id="orgd5d3397">Create SSH Key</h2>
<div class="outline-text-2" id="text-orgd5d3397">
</div>
<div id="outline-container-orgaae6902" class="outline-3">
<h3 id="orgaae6902">Create a "ed25519" key</h3>
<div class="outline-text-3" id="text-orgaae6902">
<div class="org-src-container">
<pre class="src src-shell">ssh-keygen -t ed25519 -f ~/.ssh/nameofkey -N <span style="color: #ffff88;">''</span> -C <span style="color: #ffff88;">"comment goes here"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgac972d7" class="outline-3">
<h3 id="orgac972d7">Create an "RSA" key</h3>
<div class="outline-text-3" id="text-orgac972d7">
<div class="org-src-container">
<pre class="src src-bash">ssh-keygen -t rsa -f ~/.ssh/nameofkey -N <span style="color: #ffff88;">''</span> -C <span style="color: #ffff88;">"comment goes here"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4ccab97" class="outline-3">
<h3 id="org4ccab97">Explanation</h3>
<div class="outline-text-3" id="text-org4ccab97">
<ul class="org-ul">
<li>-t option is for the type of keys to be created (ex. ed25519)</li>
<li>-f option is the filename and location of the keys (ex. <code>/path/to/file</code>)</li>
<li>-N is the passphrase to be given, leave blank for no passphrase</li>
<li>-C enter a comment to best find keys later (ex. "github key")</li>
<li>-o resident to tell OpenSSH to use the FIDO2 standard</li>
</ul>
</div>
</div>
<div id="outline-container-org5aa4c24" class="outline-3">
<h3 id="org5aa4c24">Passwords, Passphrase, Passcode???</h3>
<div class="outline-text-3" id="text-org5aa4c24">
<ul class="org-ul">
<li>Password are usually for authenticating a user to a system</li>
<li>Passphrases are used for SSH keys to lock/unlock the actual keys</li>
<li>Passcode is usually a time based one time code used to secure an account with MFA</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga65b488" class="outline-2">
<h2 id="orga65b488">Demonstrating SSH Key Generation</h2>
<div class="outline-text-2" id="text-orga65b488">
</div>
<div id="outline-container-orgd9820cf" class="outline-3">
<h3 id="orgd9820cf">Create a "ed25519-sk" key</h3>
<div class="outline-text-3" id="text-orgd9820cf">
<div class="org-src-container">
<pre class="src src-bash">ssh-keygen -t ed25519-sk -O resident -f ~/.ssh/id_testkey -N <span style="color: #ffff88;">''</span> -C <span style="color: #ffff88;">"test key for yubikey"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgda05b41" class="outline-3">
<h3 id="orgda05b41">Example</h3>
<div class="outline-text-3" id="text-orgda05b41">
<pre class="example" id="org5cbaf4b">
Generating public/private ed25519-sk key pair.
You may need to touch your authenticator to authorize key generation.
Enter PIN for authenticator:
Your identification has been saved in /home/erobles/.ssh/id_testkey
Your public key has been saved in /home/erobles/.ssh/id_testkey.pub
The key fingerprint is:
SHA256:ItBm//lTC8cpH1ikTQMWfIdtO2PDEvzwFqp2XdzffPs test key for yubikey
The key's randomart image is:
+[ED25519-SK 256]-+
|         .++ o   |
|   .     .. X =  |
|  . +      * @ +.|
|   + .    . = @ +|
|    . o S  = * *o|
|     . o .* B . =|
|        o. B o  o|
|         .. o  . |
|          ..    E|
+----[SHA256]-----+
</pre>
</div>
</div>
<div id="outline-container-orga3beec9" class="outline-3">
<h3 id="orga3beec9">Create an SSH with TOTP</h3>
</div>
</div>
<div id="outline-container-orgb0b5da3" class="outline-2">
<h2 id="orgb0b5da3">MFA is awesome!</h2>
<div class="outline-text-2" id="text-orgb0b5da3">
<p>
Multifactor authentications is great and when implemented correctly can help secure your environments. It can help ensure that you trust who is logging into your services. And ultimately can help in preventing costly security breaches.
</p>
</div>
</div>
<div id="outline-container-org4bcb324" class="outline-2">
<h2 id="org4bcb324">Watch out for these things&#x2026;</h2>
<div class="outline-text-2" id="text-org4bcb324">
<ul class="org-ul">
<li>Poorly setup MFA environments
Adding to much complexity to MFA environments is not safer and does not increase security.</li>
<li>Confusing roll-out
Think of your users and chose the best path with the least resistance.</li>
<li>Hostile users</li>
<li>ADA and Accessibility Issues
Can users with disabilities uses your MFA?</li>
</ul>
</div>
</div>
<div id="outline-container-orgd92b147" class="outline-2">
<h2 id="orgd92b147">Tips and Tricsk</h2>
<div class="outline-text-2" id="text-orgd92b147">
</div>
<div id="outline-container-orga2c588d" class="outline-3">
<h3 id="orga2c588d">Adding SSH Key To Agent</h3>
<div class="outline-text-3" id="text-orga2c588d">
</div>
<div id="outline-container-org77532bd" class="outline-4">
<h4 id="org77532bd">Check if SSH Agent is running</h4>
<div class="outline-text-4" id="text-org77532bd">
<p>
This is to add the keys to the SSH Agent
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ffbb66;">eval</span> <span style="color: #ffff88;">"$(</span><span style="color: #bb99ff; font-weight: bold;">ssh-agent</span><span style="color: #ffff88;"> -s)"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9273cf2" class="outline-4">
<h4 id="org9273cf2">Add the Keys to SSH Agent</h4>
<div class="outline-text-4" id="text-org9273cf2">
<div class="org-src-container">
<pre class="src src-bash">ssh-add ~/.ssh/nameofkey
</pre>
</div>
<p>
If you add your public key, OpenSSH will warn you to not use the public key.
</p>
</div>
</div>
<div id="outline-container-orgfd3ea1a" class="outline-4">
<h4 id="orgfd3ea1a">Verify Keys Added to SSH Agent</h4>
<div class="outline-text-4" id="text-orgfd3ea1a">
<div class="org-src-container">
<pre class="src src-bash">ssh-add -l
</pre>
</div>
</div>
</div>

<div id="outline-container-org01a14f9" class="outline-4">
<h4 id="org01a14f9">Copy Key to Remote Server</h4>
<div class="outline-text-4" id="text-org01a14f9">
<div class="org-src-container">
<pre class="src src-bash">ssh-copy-id -i ~/.ssh/testkey.pub user@remote.server.location
</pre>
</div>
<p>
Remember that you want to share your public key. Never share your Private Key!
</p>
</div>
</div>
<div id="outline-container-org8bc8a28" class="outline-4">
<h4 id="org8bc8a28">Copy Server Key to Host</h4>
<div class="outline-text-4" id="text-org8bc8a28">
<div class="org-src-container">
<pre class="src src-bash">ssh-copy-id user@host.local
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgaf40329" class="outline-3">
<h3 id="orgaf40329">SSH Config File - Make SSH Easier</h3>
<div class="outline-text-3" id="text-orgaf40329">
<p>
Let's look at a typical SSH command.
</p>

<p>
<code>ssh erobles@10.0.3.11 -p 2300 -i ~/.ssh/mykeys</code>
</p>
</div>

<div id="outline-container-orgbdf48ed" class="outline-4">
<h4 id="orgbdf48ed"><code>erobles@10.0.3.11</code> this states our username on the server and the IP/Hostname of the server</h4>
</div>

<div id="outline-container-org7239837" class="outline-4">
<h4 id="org7239837"><code>-p 2300</code> the port we are connecting to on the server</h4>
</div>

<div id="outline-container-org8b64348" class="outline-4">
<h4 id="org8b64348"><code>-i ~/.ssh/mykeys</code> the Public/Private keys used in the SSH connection</h4>
</div>
</div>
<div id="outline-container-org5d4703b" class="outline-3">
<h3 id="org5d4703b">SSH Config File cont.</h3>
<div class="outline-text-3" id="text-org5d4703b">
<p>
While this is fine, it can be time consuming and easily forgotten. So let's see how this commands translates to an SSH Config file.
</p>

<div class="org-src-container">
<pre class="src src-bash">HOST myserver
HostName 10.0.3.11
User erobles
Port 2300
IdentityFile ~/.ssh/mykeys
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org5c021cc" class="outline-2">
<h2 id="org5c021cc">Conclusion</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 05-21-22</p>
<p class="date">Created: 2022-05-19 Thu 10:45</p>
</div>
</body>
</html>
