<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Quick, Easy, Malware Investigations and Threat Hunting</title>
<meta name="author" content="Eduardo Robles"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/theme/white.css" id="theme"/>


<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'https://cdn.jsdelivr.net/npm/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1 class="title">Quick, Easy, Malware Investigations and Threat Hunting</h1><p class="subtitle"></p>
<h2 class="date">20240216</h2><p class="date">Created: 2024-11-10 Sun 09:13</p>
</section>

<section>
<section id="slide-orgd388f97">
<h2 id="orgd388f97">Bsides Austin 2024</h2>
<div class="org-center">
<p>
Quick, Easy, Malware Investigations and Threat Hunting
</p>
</div>

</section>
</section>
<section>
<section id="slide-org3c4408e">
<h2 id="org3c4408e">About Me</h2>
<ul>
<li>Hi! I'm Eduardo Robles I work for County of Hidalgo IT dept as a Cybersecurity Analyst IV</li>
<li>Founder of South Texas Linux Users Group.</li>
<li>You can check out my skills on my blog or LinkedIn.</li>

</ul>
</section>
</section>
<section>
<section id="slide-org6454afd">
<h2 id="org6454afd">Agenda</h2>
<ol>
<li>Learn the basics of Malware Analysis</li>
<li>Learn some Threat Hunting skills</li>
<li>Small look at Reverse Engineering and Digital Forensics</li>

</ol>
</section>
</section>
<section>
<section id="slide-org6eddf63">
<h2 id="org6eddf63">Malware Investigations</h2>
<div class="outline-text-2" id="text-org6eddf63">
</div>
</section>
<section id="slide-org23ac5bb">
<h3 id="org23ac5bb">Why do internal malware analysis?</h3>
<ul>
<li>Existing tools Virustotal, JoeSandbox, etc.</li>
<li>Protect sensitive information from 3rd parties.</li>
<li>Freedom from reliance on one tool or platform.</li>

</ul>
</section>
<section id="slide-orga029a06">
<h3 id="orga029a06">Malware is scary and dangerous, put in a box (container).</h3>
<p>
Malware is scary. Malware is dangerous. So it's best to analyze in a contained environment.
</p>
<ul>
<li>Virtual Machines</li>
<li>Containers (Docker, Podman, etc)</li>

</ul>
</section>
<section id="slide-orgb861b74">
<h3 id="orgb861b74">Working with Malware Samples</h3>
<p>
Safely moving malware around to later analyze can be daunting. Here are some pointers.
</p>
</section>
<section id="slide-org464d263">
<h4 id="org464d263">Defang</h4>
<p>
Take a normal hyperlink or file extention and defang it so it's not active.
</p>
<ul>
<li>Normal</li>

</ul>
<pre class="example" id="org3689fd9">
https://eduardorobles.com or superbadmalware.exe
</pre>
<ul>
<li>Defanged</li>

</ul>
<pre class="example" id="org93727af">
hxxps://eduardorobles[.]com or superbadmalware.malz
</pre>
</section>
<section id="slide-org50aa8c6">
<h4 id="org50aa8c6">Encrypted Archive with a Password (7zip)</h4>
<p>
Use 7zip to password encrypt an archive. This add an extra layer of protection by not allowing someone to accidently open the archive.
</p>
</section>
<section id="slide-orgdfbab64">
<h4 id="orgdfbab64">Disable network access</h4>
<ul>
<li>You can disable network access to your malware analysis station.</li>
<li>This stops malware from communicating to a C2 infrastruture.</li>
<li>Or you can also simulate network traffic if you want to analyze what the malware might be trying to communicate with.</li>

</ul>
</section>
<section id="slide-org3e88e69">
<h3 id="org3e88e69">REMnux</h3>
<p>
If you want easy button for malware analysis use <b>REMnux</b> as a VM or a container!
<a href="https://remnux.org">https://remnux.org</a>
</p>
<blockquote >
<p>
REMnux: A Linux Toolkit for Malware Analysis
</p>
</blockquote>

</section>
<section id="slide-org8cc472f">
<h3 id="org8cc472f">Setup REMnux in a Container</h3>
<p>
REMnux offers several <a href="https://docs.remnux.org/install-distro/remnux-as-a-container">container</a> images as well the full REMnux distro in a container.
</p>
<ul>
<li>The container technology they chose is Docker but I have chosen to use Podman.</li>
<li>Podman seems to have better support in Windows as well as Linux.</li>
<li>So I can have Podman running in both the Malware Analysis station and on my Windows machine. This gives me the flexibility to test on either machine or platform.</li>

</ul>
</section>
<section id="slide-org6330285">
<h4 id="org6330285">Install REMnux container</h4>
<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>podman pull docker.io/remnux/remnux-distro:focal
</code></pre>
</div>
</section>
<section id="slide-org3a53d39">
<h4 id="org3a53d39">Run REMnux as a Transient container</h4>
<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>podman run <span style="color: #af9fff;">\</span>
       --rm <span style="color: #af9fff;">\</span>
       -d <span style="color: #af9fff;">\</span>
       --name malContainer <span style="color: #af9fff;">\</span>
       -v /var/home/core/SAMPLES:/home/remnux/files <span style="color: #af9fff;">\</span>
       --privileged <span style="color: #af9fff;">\</span>
       --network none <span style="color: #af9fff;">\</span>
       remnux/remnux-distro:focal
</code></pre>
</div>
<aside class="notes">
<p>
What the previous command did
</p>
<ul>
<li><code>--rm</code> Remove the container after it exists (not the image)</li>
<li><code>-it</code> Connect the container to the terminal</li>
<li><code>-u remnux</code> Logged in user (optional)</li>
<li><code>--privileged</code> Runs container with Root privileges (optional)</li>

</ul>
<p>
= <code>--network none</code> Disables any network from the container (optional)
</p>
<ul>
<li><code>remnux/remnux-distro:focal</code> Container image to use, in this case use the local image</li>
<li><code>bash</code> Login shell</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-org8353c45">
<h2 id="org8353c45">Digital Forensics</h2>
<div class="outline-text-2" id="text-org8353c45">
</div>
</section>
<section id="slide-org17061f9">
<h3 id="org17061f9">Phishing Email Analysis</h3>
<div class="outline-text-3" id="text-org17061f9">
</div>
</section>
<section id="slide-org4c26cfe">
<h4 id="org4c26cfe">ClamAV</h4>
<p>
ClamAV is great to scan for malware but also can scan <code>eml</code> files including email attachments. Use the <code>--debug</code> flag for more info on the scan.
</p>
<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>clamscan sample.eml
</code></pre>
</div>
</section>
<section id="slide-orgec0f4e7">
<h4 id="orgec0f4e7">Continued</h4>
<p>
You can also use ClamAV to scan any suspicious file.
</p>
<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>clamscan sample.zip
</code></pre>
</div>

</section>
<section id="slide-org6ee9cd8">
<h3 id="org6ee9cd8">Investigating a malicious link</h3>
<p>
To investigate a link REMnux offers so many awesome tools. I will cover THUG and Automater.
</p>
</section>
<section id="slide-org627e9d6">
<h4 id="org627e9d6">THUG</h4>
<p>
THUG is a “honeyclient”. A honeyclient is a tool that mimicks the behavior of a web browser. Useful for analyzing what a link does when a user clicks on it.
</p>

<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>thug -u win7chrome49 <span style="color: #af9fff;">"https://eduardorobles.com"</span>
</code></pre>
</div>
</section>
<section id="slide-org7ae69de">
<h4 id="org7ae69de">Continued&#x2026;</h4>
<p>
Once it begins to “load” the suspicious site it executes any code that may be on the site. Once it is done running/loading the page it dumps a report. The report contains a summary of what occured plus you get any malicious artifacts that the page may have downloaded.
</p>

<p>
In one exercise a suspicous page downloaded an executable and I was able to analyze the executable from the container and it was indeed a malicous executable. Yikes!
</p>
</section>
<section id="slide-orgc3c5415">
<h4 id="orgc3c5415">Automater</h4>
<blockquote >
<p>
Automater is a URL/Domain, IP Address, and Md5 Hash OSINT tool aimed at making the analysis process easier for intrusion Analysts. Given a target (URL, IP, or HASH) or a file full of targets Automater will return relevant results from sources like the following: IPvoid.com, Robtex.com, Fortiguard.com, unshorten.me, Urlvoid.com, Labs.alienvault.com, ThreatExpert, VxVault, and VirusTotal.
</p>
</blockquote>
</section>
<section id="slide-org8895ed9">
<h4 id="org8895ed9">Continued&#x2026;</h4>
<p>
Automater is a python tool found in <code>/usr/local/automater</code>
</p>
<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>./Automater.py https://eduardorobles.com
</code></pre>
</div>


</section>
<section id="slide-org87cad40">
<h3 id="org87cad40">Investigating a suspicious PDF</h3>
<p>
Malicous content will be embedded. It's best to extract the content in order to inspect it.
</p>

</section>
<section id="slide-orgcb13427">
<h4 id="orgcb13427">Strings</h4>
<p>
You can use the command <code>strings</code> to view all the different system call a file contains.
</p>
<pre  class="example" >
strings sus_invoice.pdf | grep http
</pre>

<p>
You can also pipe grep to single out things like <code>http</code> links or hashes.
</p>
</section>
<section id="slide-org0ddeddb">
<h4 id="org0ddeddb">Magika</h4>
<pre  class="example" >
pip install magika
</pre>
</section>
</section>
<section>
<section id="slide-org3d5c7ef">
<h2 id="org3d5c7ef">Threat Hunting</h2>
<div class="outline-text-2" id="text-org3d5c7ef">
</div>
</section>
<section id="slide-org41cb2cc">
<h3 id="org41cb2cc">Velociraptor</h3>
<p>
Worth every penny!
</p>
</section>
<section id="slide-orga3f585a">
<h3 id="orga3f585a">Setup REMnux container for Analysis</h3>
<p>
This container will run in priviledged mode and will have no network attached to it
</p>
<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>podman run --rm -it <span style="color: #af9fff;">\</span>
       --name malContainer <span style="color: #af9fff;">\</span>
       --privileged <span style="color: #af9fff;">\</span>
       --network none <span style="color: #af9fff;">\</span>
       remnux/remnux-distro:focal bash
</code></pre>
</div>
</section>
<section id="slide-org15b19f3">
<h3 id="org15b19f3">Yara</h3>
<p>
<a href="https://github.com/airbnb/binaryalert/blob/master/rules/public/eicar.yara">https://github.com/airbnb/binaryalert/blob/master/rules/public/eicar.yara</a>
</p>
<div class="org-src-container">

<pre  class="src src-yara"   ><code trim><span style="color: #00c089; font-weight: bold;">rule</span> <span style="color: #7fc500;">eicar_av_test</span> {
    <span style="color: #b7a07f; font-style: italic;">/*</span>
<span style="color: #b7a07f; font-style: italic;">       Per standard, match only if entire file is EICAR string plus optional trailing whitespace.</span>
<span style="color: #b7a07f; font-style: italic;">       The raw EICAR string to be matched is:</span>
<span style="color: #b7a07f; font-style: italic;">       X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*</span>
<span style="color: #b7a07f; font-style: italic;">    */</span>

    <span style="color: #cfc04f;">meta</span>:
        <span style="color: #37aff6;">description</span> = <span style="color: #af9fff;">"This is a standard AV test, intended to verify that BinaryAlert is working correctly."</span>
        <span style="color: #37aff6;">author</span> = <span style="color: #af9fff;">"Austin Byers | Airbnb CSIRT"</span>
        <span style="color: #37aff6;">reference</span> = <span style="color: #af9fff;">"http://www.eicar.org/86-0-Intended-use.html"</span>

    <span style="color: #cfc04f;">strings</span>:
        <span style="color: #78afff;">$eicar_regex</span> = /^X5O!P%@AP\[4\\PZX54\(P\^\)7CC\)7\}\<span style="color: #78afff;">$EICAR</span>-STANDARD-ANTIVIRUS-TEST-FILE!\<span style="color: #78afff;">$H</span>\+H\*\s*$/

    <span style="color: #cfc04f;">condition</span>:
        <span style="color: #00c089; font-weight: bold;">all</span> <span style="color: #00c089; font-weight: bold;">of</span> <span style="color: #00c089; font-weight: bold;">them</span>
}

<span style="color: #00c089; font-weight: bold;">rule</span> <span style="color: #7fc500;">eicar_substring_test</span> {
    <span style="color: #b7a07f; font-style: italic;">/*</span>
<span style="color: #b7a07f; font-style: italic;">       More generic - match just the embedded EICAR string (e.g. in packed executables, PDFs, etc)</span>
<span style="color: #b7a07f; font-style: italic;">    */</span>

    <span style="color: #cfc04f;">meta</span>:
        <span style="color: #37aff6;">description</span> = <span style="color: #af9fff;">"Standard AV test, checking for an EICAR substring"</span>
        <span style="color: #37aff6;">author</span> = <span style="color: #af9fff;">"Austin Byers | Airbnb CSIRT"</span>

    <span style="color: #cfc04f;">strings</span>:
        <span style="color: #78afff;">$eicar_substring</span> = <span style="color: #af9fff;">"$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!"</span>

    <span style="color: #cfc04f;">condition</span>:
        <span style="color: #00c089; font-weight: bold;">all</span> <span style="color: #00c089; font-weight: bold;">of</span> <span style="color: #00c089; font-weight: bold;">them</span>
}
</code></pre>
</div>
</section>
<section id="slide-org6fd3c03">
<h3 id="org6fd3c03">Tools</h3>
<div class="outline-text-3" id="text-org6fd3c03">
</div>
</section>
<section id="slide-org01e89b4">
<h4 id="org01e89b4">Cyberchef</h4>
<p>
A great tool!
</p>
<blockquote >
<p>
GCHQ CyberChef in a container. CyberChef is the Cyber Swiss Army Knife web app for encryption, encoding, compression and data analysis.
</p>
</blockquote>
<p>
Let's run it in a container!
</p>
<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>podman run <span style="color: #af9fff;">\</span>
       -d <span style="color: #af9fff;">\</span>
       --name cyberchef <span style="color: #af9fff;">\</span>
       -p 8000:8000 <span style="color: #af9fff;">\</span>
       mpepping/cyberchef
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org23757f9">
<h2 id="org23757f9">Conclusion</h2>

</section>
</section>
<section>
<section id="slide-org2b6d8ae">
<h2 id="org2b6d8ae">Questions</h2>

</section>
</section>
<section>
<section id="slide-orgf2faaf0">
<h2 id="orgf2faaf0">Thanks</h2>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]

});

</script>
</body>
</html>
